###### VM OPERATIONS ########
---
- name: VM operations playbook
  hosts: localhost
  gather_facts: false
  collections:
    - nutanix.ncp
  module_defaults:
    group/nutanix.ncp.ntnx:
      nutanix_host: <host_ip>
      nutanix_username: <user>
      nutanix_password: <pass>
      validate_certs: false
  tasks:
  - name: Setting Variables
    set_fact:
        script_path: ""
        subnet_name: ""
        vm_uuid: ""
        
  - name: hard power off the vm
    ntnx_vms:
        state: present
        vm_uuid: "{{ vm_uuid }}"
        operation: hard_poweroff
    register: result
    ignore_errors: true
    
  - name: create_ova_image  while vm is on
    ntnx_vms:
        state: present
        vm_uuid: "{{ vm_uuid }}"
        operation: create_ova_image
        ova_name: integration_test_VMDK_ova
        ova_file_format: VMDK
        wait: true
    register: result
    ignore_errors: true

  - name: clone vm while it's off also add network and script
    ntnx_vms:
        state: present
        vm_uuid: "{{ vm_uuid }}"
        operation: clone
        networks:
          - is_connected: true
            subnet:
              name: "{{ subnet_name }}"
        guest_customization:
          type: "cloud_init"
          script_path: "{{ script_path }}"
          is_overridable: True
    register: result
    ignore_errors: true
