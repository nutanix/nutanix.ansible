---
# Summary:
# This playbook will do:
# 1. Create certificate authentication provider with CAC enabled
# 2. Update certificate authentication provider
# 3. List all certificate authentication providers
# 4. Get specific certificate authentication provider
# 5. Delete created certificate authentication provider

- name: Certificate Authentication Provider playbook
  hosts: localhost
  gather_facts: false
  module_defaults:
    group/nutanix.ncp.ntnx:
      nutanix_host: <pc_ip>
      nutanix_username: <user>
      nutanix_password: <pass>
      validate_certs: false
  tasks:
    - name: Setting Variables
      ansible.builtin.set_fact:
        ca_chain_content: |
          -----BEGIN CERTIFICATE-----
          MIIDXTCCAkWgAwIBAgIJAJC1HiIAZAiUMA0GCSqGSIb3Qa2sdfasdfasdfsadfsd
          ... (certificate content) ...
          -----END CERTIFICATE-----
        ca_cert_file_name: "test_ca_chain.pem"
        directory_service_ext_id: "a1b2c3d4-e5f6-7890-abcd-ef1234567890"

    - name: Create certificate authentication provider with CAC enabled
      nutanix.ncp.ntnx_certificate_auth_provider_v2:
        state: present
        name: "CAC"
        client_ca_chain: "{{ ca_chain_content }}"
        ca_cert_file_name: "{{ ca_cert_file_name }}"
        is_cert_auth_enabled: true
        is_cac_enabled: true
        dir_svc_ext_id: "{{ directory_service_ext_id }}"
      register: result_cac
      ignore_errors: true

    - name: Set cert authentication provider ext_id for CAC
      ansible.builtin.set_fact:
        cert_auth_ext_id_cac: "{{ result_cac.ext_id }}"

    - name: Update certificate authentication provider
      nutanix.ncp.ntnx_certificate_auth_provider_v2:
        state: present
        ext_id: "{{ cert_auth_ext_id_cac }}"
        is_cac_enabled: false
      register: result
      ignore_errors: true

    - name: List all certificate authentication providers (returns list containing only one certificate authentication provider)
      nutanix.ncp.ntnx_certificate_auth_providers_info_v2:
      register: result
      ignore_errors: true

    - name: List all certificate authentication providers with page and limit
      nutanix.ncp.ntnx_certificate_auth_providers_info_v2:
        page: 0
        limit: 1
      register: result
      ignore_errors: true

    - name: Get specific certificate authentication provider
      nutanix.ncp.ntnx_certificate_auth_providers_info_v2:
        ext_id: "{{ cert_auth_ext_id_cac }}"
      register: result
      ignore_errors: true

    - name: Delete certificate authentication provider
      nutanix.ncp.ntnx_certificate_auth_provider_v2:
        state: absent
        ext_id: "{{ cert_auth_ext_id_cac }}"
      register: result
      ignore_errors: true
