---
name: Integration Test cases
on:
  pull_request:
  repository_dispatch:
    types: [ok-to-test-command]

jobs:
  integration_test_cases:
    timeout-minutes: 600
    runs-on: self-hosted
    strategy:
      max-parallel: 1
      matrix:
        python-version: ["3.10"]
    if: github.event_name == 'repository_dispatch'

    steps:
      - run: echo "ðŸŽ‰ The job was automatically triggered by a ${{ github.event_name }} event."

      - uses: actions/checkout@v2
        with:
          ref: refs/pull/${{ github.event.client_payload.pull_request.number }}/merge

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          pip install -r tests/integration/requirements.txt
          ansible-galaxy collection install community.general --force

      - name: Build and install the collection
        run: |
          NAMESPACE=$(cat galaxy.yml | shyaml get-value namespace)
          COLLECTION_NAME=$(cat galaxy.yml | shyaml get-value name)
          VERSION=$(cat galaxy.yml | shyaml get-value version)
          echo "NAMESPACE=${NAMESPACE}" >> $GITHUB_ENV
          echo "COLLECTION_NAME=${COLLECTION_NAME}" >> $GITHUB_ENV
          ansible-galaxy collection build --force
          ansible-galaxy collection install ${NAMESPACE}-${COLLECTION_NAME}-${VERSION}.tar.gz --force

      - name: Run Integration test cases
        run: |
          cd /home/${USER}/.ansible/collections/ansible_collections/${{ env.NAMESPACE }}/${{ env.COLLECTION_NAME }}

          export NUTANIX_HOST=${{ secrets.PC_IP }}
          export NUTANIX_PASSWORD=${{ secrets.PC_PASSWORD }}
          export NUTANIX_USERNAME=${{ secrets.PC_USERNAME }}
          export NUTANIX_DR_SITE=${{ secrets.NUTANIX_DR_SITE }}
          export VALIDATE_CERTS=${{ secrets.VALIDATE_CERTS }}
          export NDB_HOST=${{ secrets.NDB_HOST }}
          export NDB_PASSWORD=${{ secrets.NDB_PASSWORD }}
          export NDB_USERNAME=${{ secrets.NDB_USERNAME }}
          export NUTANIX_DEBUG=${{ secrets.NUTANIX_DEBUG }}
          export NUTANIX_LOG_PATH=${{ secrets.NUTANIX_LOG_PATH }}
          args="${{ github.event.client_payload.slash_command.args.all }}"
          flag=""
          if [ "$args" = "allow-disabled" ]; then
              flag="--allow-disabled"
          elif [ -n "$args" ]; then
              regex_pattern="$args"
          fi
          echo '${{ secrets.FOUNDATION_CONFIG }}' > tests/integration/targets/prepare_foundation_env/vars/main.yml
          echo '${{ secrets.FC_CONFIG }}' > tests/integration/targets/prepare_fc_env/vars/main.yml
          echo '${{ secrets.PC_CONFIG }}' > tests/integration/targets/prepare_env/vars/main.yml
          echo '${{ secrets.NDB_CONFIG }}' > tests/integration/targets/prepare_ndb_env/vars/main.yml
          echo "NUTANIX_HOST=${{ secrets.PC_IP }}" >> $GITHUB_ENV
          echo "NUTANIX_USERNAME=${{ secrets.PC_USERNAME }}" >> $GITHUB_ENV
          echo "NUTANIX_PASSWORD=${{ secrets.PC_PASSWORD }}" >> $GITHUB_ENV

          echo "===> Preparing environments..."
          ansible-playbook tests/integration/targets/prepare_env/playbooks/prepare_env.yml
          ansible-playbook tests/integration/targets/prepare_ndb_env/playbooks/prepare_env.yml
          ansible-playbook tests/integration/targets/prepare_fc_env/playbooks/prepare_fc_env.yml
          ansible-playbook tests/integration/targets/prepare_foundation_env/playbooks/prepare_foundation_env.yml

          if [ -n "$regex_pattern" ] && [[ "$regex_pattern" =~ inventory_tests ]]; then
              echo "regex_pattern contains 'inventory_tests'. Running all inventory tests..."
              echo "===> Running inventory test (default host)..."
              if ansible-playbook -i tests/integration/targets/inventory_test/inventory_test_default_host/nutanix.yml \
              tests/integration/targets/inventory_test/inventory_test_default_host/inventory.yml \
              2>&1 | tee -a test_output.log; then
                  echo "Inventory test default host completed successfully."
              else
                  echo "Inventory test default host failed. See logs above." | tee -a test_output.log
              fi
              echo "===> Running inventory test (custom host)..."
              if ansible-playbook -i tests/integration/targets/inventory_test/inventory_test_custom_host/nutanix.yml \
              tests/integration/targets/inventory_test/inventory_test_custom_host/inventory.yml \
              2>&1 | tee -a test_output.log; then
                  echo "Inventory test custom host completed successfully."
              else
                  echo "Inventory test custom host failed. See logs above." | tee -a test_output.log
              fi
              echo "===> Running inventory test (negative tests)..."
              if ansible-playbook -i tests/integration/targets/inventory_test/inventory_test_negative_test_1/nutanix.yml \
              tests/integration/targets/inventory_test/inventory_test_negative_test_1/inventory.yml \
              2>&1 | tee -a test_output.log; then
                  echo "Inventory test negative test 1 completed successfully."
              else
                  echo "Inventory test negative test 1 failed. See logs above." | tee -a test_output.log
              fi
              if ansible-playbook -i tests/integration/targets/inventory_test/inventory_test_negative_test_2/nutanix.yml \
              tests/integration/targets/inventory_test/inventory_test_negative_test_2/inventory.yml \
              2>&1 | tee -a test_output.log; then
                  echo "Inventory test negative test 2 completed successfully."
              else
                  echo "Inventory test negative test 2 failed. See logs above." | tee -a test_output.log
              fi
          fi

          echo "===> Running integration tests..."
          set +e
          if [ -n "$regex_pattern" ]; then
              echo "Filtering integration tests by regex: $regex_pattern"
              mapfile -t matched_dirs < <(find tests/integration/targets -maxdepth 1 -mindepth 1 -type d -printf "%f\n" | grep -E "$regex_pattern" || true)
              if [ ${#matched_dirs[@]} -eq 0 ]; then
                  echo "âŒ No integration test targets matched regex: '$regex_pattern'."
                  echo "No test execution performed." | tee test_output.log
                  echo "NO_REGEX_MATCH=true" >> $GITHUB_ENV
                  echo "RESULTS=No tests matched regex pattern '$regex_pattern'. Skipping test run." >> $GITHUB_ENV
                  TEST_EXIT_CODE=0
              else
                  ansible-test integration --continue-on-error \
                    --python ${{ matrix.python-version }} --coverage "${matched_dirs[@]}" --allow-disabled 2>&1 | tee test_output.log
                  TEST_EXIT_CODE=${PIPESTATUS[0]}
              fi
          else
              ansible-test integration --continue-on-error \
                --python ${{ matrix.python-version }} --coverage $flag 2>&1 | tee test_output.log
              TEST_EXIT_CODE=${PIPESTATUS[0]}
          fi
          set -e

          echo "===> Generating coverage report..."
          ansible-test coverage report > coverage.txt

          if [ "$TEST_EXIT_CODE" -ne 0 ]; then
              echo "âŒ One or more integration tests failed."
              echo "INTEGRATION_STATUS=failed" >> $GITHUB_ENV
              exit 1
          else
              echo "âœ… All integration tests passed successfully."
              echo "INTEGRATION_STATUS=passed" >> $GITHUB_ENV
          fi

      - name: Cleanup Environments
        if: ${{ always() }}
        run: |
          cd /home/${USER}/.ansible/collections/ansible_collections/${{ env.NAMESPACE }}/${{ env.COLLECTION_NAME }}
          echo "ðŸ§¹ Cleaning up environments..."
          ansible-playbook tests/integration/targets/prepare_env/playbooks/cleanup.yml
          ansible-playbook tests/integration/targets/prepare_foundation_env/playbooks/cleanup.yml

      - name: Generate test summary
        if: ${{ always() }}
        run: |
          cd /home/${USER}/.ansible/collections/ansible_collections/${{ env.NAMESPACE }}/${{ env.COLLECTION_NAME }}
          echo "### Detailed Test Results" >> $GITHUB_STEP_SUMMARY

          LOG_FILE="test_output.log"
          declare -A test_results
          current_test=""

          if [ -f "$LOG_FILE" ]; then
            # Parse test_output.log and populate test_results[current_test]="PASSED"|"FAILED"
            while IFS= read -r line; do
                if [[ $line =~ ^Running\ ([^[:space:]]+)\ integration\ test\ role ]]; then
                    current_test="${BASH_REMATCH[1]}"
                fi
                if [[ $line =~ ^PLAY\ RECAP ]]; then
                    read -r recap_line
                    if [[ $recap_line =~ failed=([0-9]+) ]]; then
                        failed_count="${BASH_REMATCH[1]}"
                        if [[ "$failed_count" -eq 0 ]]; then
                            test_results["$current_test"]="PASSED"
                        else
                            test_results["$current_test"]="FAILED"
                        fi
                    fi
                fi
            done < "$LOG_FILE"

            # Build ordered lists
            passed_tests=()
            failed_tests=()
            for test in "${!test_results[@]}"; do
              if [ "${test_results[$test]}" = "PASSED" ]; then
                passed_tests+=("$test")
              else
                failed_tests+=("$test")
              fi
            done

            pass_count=${#passed_tests[@]}
            fail_count=${#failed_tests[@]}
            total_count=$((pass_count + fail_count))

            # Write multi-line RESULTS env var for PR comment step
            {
              echo "RESULTS<<EOF"
              echo "### Summary:"
              echo "- Total Tests: $total_count"
              echo "- Passed: $pass_count"
              echo "- Failed: $fail_count"
              echo ""
              echo "### Passed Tests:"
              if [ $pass_count -gt 0 ]; then
                for t in "${passed_tests[@]}"; do
                  echo "- $t"
                done
              else
                echo "- None"
              fi
              echo ""
              echo "### Failed Tests:"
              if [ $fail_count -gt 0 ]; then
                for t in "${failed_tests[@]}"; do
                  echo "- $t"
                done
              else
                echo "- None"
              fi
              echo ""
              echo "Raw log file: test_output.log"
              echo "EOF"
            } >> $GITHUB_ENV

            # Append same info to job summary (visible in Actions UI)
            {
              echo "### Summary:"
              echo "- Total Tests: $total_count"
              echo "- Passed: $pass_count"
              echo "- Failed: $fail_count"
              echo ""
              echo "### Passed Tests:"
              if [ $pass_count -gt 0 ]; then
                for t in "${passed_tests[@]}"; do
                  echo "- $t"
                done
              else
                echo "- None"
              fi
              echo ""
              echo "### Failed Tests:"
              if [ $fail_count -gt 0 ]; then
                for t in "${failed_tests[@]}"; do
                  echo "- $t"
                done
              else
                echo "- None"
              fi
            } >> $GITHUB_STEP_SUMMARY

          else
            echo "No test_output.log found" >> $GITHUB_STEP_SUMMARY
            echo "RESULTS=No detailed results (test_output.log missing)" >> $GITHUB_ENV
          fi

      - name: Code Coverage Check
        if: ${{ always() }}
        run: |
          cd /home/${USER}/.ansible/collections/ansible_collections/${{ env.NAMESPACE }}/${{ env.COLLECTION_NAME }}
          ansible-test coverage html
          echo "Code coverage: Checking if code coverage is above threshold..."
          export COVERAGE_THRESHOLD=50
          echo "Threshold: $COVERAGE_THRESHOLD %"
          totalCoverage=`grep TOTAL coverage.txt | awk '{print $6}' | sed 's/%//'`
          echo "TOTAL_COVERAGE=${totalCoverage}" >> $GITHUB_ENV
          echo "Current integration test coverage : $totalCoverage %"
          if (( $(echo "$totalCoverage $COVERAGE_THRESHOLD" | awk '{print ($1 > $2)}') )); then
              echo "Coverage passed"
          else
              echo "Current integration test coverage is below threshold. Please add more integration tests or adjust threshold to a lower value."
              echo "Coverage check failed"
              exit 1
          fi

      - run: echo "ðŸ This job's status is ${{ job.status }}."

      - name: Update comment
        uses: peter-evans/create-or-update-comment@v1
        if: ${{ always() }}
        with:
          comment-id: ${{ github.event.client_payload.github.payload.comment.id }}
          body: |
            > Integration test run status is : ${{ job.status }}
            > Coverage is : ${{ env.TOTAL_COVERAGE }} %
            > Job link: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### Detailed Test Results
            ```text
            ${{ env.RESULTS ||
                (env.NO_REGEX_MATCH &&
                'No integration test targets matched regex')
                || 'No detailed results found.' }}
            ```
          reaction-type: hooray

      - name: Add summary
        if: ${{ always() }}
        run: |
          echo "### Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Coverage: ${{ env.TOTAL_COVERAGE }}%" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Detailed Test Results" >> $GITHUB_STEP_SUMMARY

          cd /home/${USER}/.ansible/collections/ansible_collections/${{ env.NAMESPACE }}/${{ env.COLLECTION_NAME }}
          if [ -f test_output.log ]; then
            grep -E "SUCCESS|FAIL" test_output.log | sed 's/^/ - /' >> $GITHUB_STEP_SUMMARY || echo "No results parsed" >> $GITHUB_STEP_SUMMARY
          else
            echo "No detailed results (test_output.log missing)" >> $GITHUB_STEP_SUMMARY
          fi
