---
# Variables required before running this playbook:
# - cluster

- name: Start ntnx_vms_v2 tests
  ansible.builtin.debug:
    msg: Start ntnx_vms_v2 tests

- name: Generate random name
  ansible.builtin.set_fact:
    random_name: "{{query('community.general.random_string',numbers=false, special=false,length=12)[0]}}"

- name: Set VM names
  ansible.builtin.set_fact:
    vm_name: "{{ random_name }}_vm_test"

- name: Set project name
  ansible.builtin.set_fact:
    project_name: "{{ random_name }}_project_test"

- name: Create Project with all specs
  nutanix.ncp.ntnx_projects:
    name: "{{project_name}}"
    desc: desc-123
    clusters:
      - "{{ cluster.uuid }}"
    users:
      - "{{ users[0] }}"
      - "{{ users[1] }}"
  register: result
  ignore_errors: true

- name: Creation Status
  ansible.builtin.assert:
    that:
      - result.response is defined
      - result.response.status.state == 'COMPLETE'
      - result.response.status.name == "{{project_name}}"
      - result.response.status.description == 'desc-123'
      - result.response.status.resources.user_reference_list[0].uuid in "{{users[0]}}"
      - result.response.status.resources.user_reference_list[1].uuid in "{{users[1]}}"
      - result.response.status.resources.cluster_reference_list[0].uuid == "{{ cluster.uuid }}"

    fail_msg: "Unable to create project with all specifications"
    success_msg: "Project with all specifications created successfully"

- name: Add project uuid to delete list
  ansible.builtin.set_fact:
    project_uuid: "{{ result.response.ext_id }}"

- name: Create VM
  nutanix.ncp.ntnx_vms_v2:
    state: present
    name: "{{ vm_name }}"
    cluster:
      ext_id: "{{ cluster.uuid }}"
    description: "Test VM"
    num_sockets: 1
    num_threads_per_core: 1
    num_cores_per_socket: 1
    num_numa_nodes: 1
    memory_size_bytes: 2147483648
    machine_type: "PC"
    is_vcpu_hard_pinning_enabled: false
    is_cpu_passthrough_enabled: true
    is_memory_overcommit_enabled: false
    is_gpu_console_enabled: false
    is_branding_enabled: false
    is_vga_console_enabled: true
    is_agent_vm: false
    enabled_cpu_features:
      - "HARDWARE_VIRTUALIZATION"
    project:
      ext_id: "{{ project_uuid }}"

  register: result
  ignore_errors: true

- name: Creation Status
  ansible.builtin.assert:
    that:
      - result.response is defined
      - result.changed == true
      - result.failed == false
      - result.response.cluster.ext_id == "{{ cluster.uuid }}"
      - result.response.name == "{{ vm_name }}"
      - result.response.description == "Test VM"
      - result.response.num_sockets == 1
      - result.response.num_threads_per_core == 1
      - result.response.num_cores_per_socket == 1
      - result.response.num_numa_nodes == 1
      - result.response.memory_size_bytes == 2147483648
      - result.response.machine_type == "PC"
      - result.response.is_vcpu_hard_pinning_enabled == false
      - result.response.is_cpu_passthrough_enabled == true
      - result.response.is_memory_overcommit_enabled == false
      - result.response.is_gpu_console_enabled == false
      - result.response.is_branding_enabled == false
      - result.response.is_vga_console_enabled == true
      - result.response.is_agent_vm == false
      - result.response.enabled_cpu_features[0] == "HARDWARE_VIRTUALIZATION"
      - result.response.project.ext_id == "{{ project_uuid }}"
    fail_msg: "Unable to Create VM "
    success_msg: "VM is created successfully "

- name: Set vm_uuid
  ansible.builtin.set_fact:
    vm_uuid: '{{ result.response.ext_id }}'

################################################################################

- name: Assign owner to VM
  nutanix.ncp.ntnx_vm_owner_v2:
    vm_ext_id: "{{ vm_uuid }}"
    owner:
      ext_id: "{{ users[0] }}"
  register: result
  ignore_errors: true

- name: Assign owner to VM Status
  ansible.builtin.assert:
    that:
      - result.response is defined
      - result.changed == true
      - result.failed == false
      - result.response.vm_ext_id == "{{ vm_uuid }}"
      - result.response.ownership_info.owner.ext_id == "{{ users[0] }}"
    fail_msg: "Unable to Assign owner to VM "
    success_msg: "Owner is assigned to VM successfully "

################################################################################

- name: Delete the VM
  nutanix.ncp.ntnx_vms_v2:
    state: absent
    ext_id: "{{ vm_uuid }}"
  register: result
  ignore_errors: true

- name: Deletion Status
  ansible.builtin.assert:
    that:
      - result.response is defined
      - result.changed == true
      - result.failed == false
      - result.response.status == 'SUCCEEDED'
      - result.ext_id == "{{ vm_uuid }}"
    fail_msg: "Unable to delete VM "
    success_msg: "VM is deleted successfully "
