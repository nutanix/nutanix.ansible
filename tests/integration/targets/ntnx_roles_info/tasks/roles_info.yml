- debug:
    msg: start testing ntnx_roles_info
##################################################

- name: List all roles
  ntnx_roles_info:
  register: result
  ignore_errors: True

- name: Listing Status
  assert:
    that:
      - result.response is defined
      - result.response.metadata.total_matches > 0
      - result.response.entities | length > 0
    fail_msg: "Unable to list all roles"
    success_msg: "roles info obtained successfully"

- set_fact:
    test_role_name: "{{result.response.entities.1.status.name}}"
- set_fact:
    test_role_uuid: "{{result.response.entities.1.metadata.uuid}}"

################################################## 

- name: List role using uuid criteria
  ntnx_roles_info:
    role_uuid: "{{ test_role_uuid }}"
  register: result
  ignore_errors: True

- name: Listing Status
  assert:
    that:
      - result.response is defined
      - result.changed == false
      - result.failed == false
      - result.response.status.name == "{{ test_role_name }}"
      - result.response.metadata.kind == "role"
    fail_msg: "Unable to list role using uuid"
    success_msg: "role info obtained successfully"

################################################## 

- name: List roles using filter criteria
  ntnx_roles_info:
    filter: 
      name: "{{ test_role_name }}"
  register: result
  ignore_errors: True

- name: Listing Status
  assert:
    that:
      - result.response is defined
      - result.changed == false
      - result.failed == false
      - result.response.entities[0].status.name == "{{ test_role_name }}"
      - result.response.metadata.kind == "role"
      - result.response.metadata.total_matches == 1
    fail_msg: "Unable to list roles using filter"
    success_msg: "role info obtained successfully"

################################################## 

- name: List roles using length and offset
  ntnx_roles_info:
    length: 1
    offset: 1
  register: result
  ignore_errors: True

- name: Listing Status
  assert:
    that:
      - result.response is defined
      - result.changed == false
      - result.failed == false
    fail_msg: "Unable to list roles using length and offset"
    success_msg: "roles listed successfully using length and offset"
##################################################
- name: List roles using ascending name sorting
  ntnx_roles_info:
    sort_order: "ASCENDING"
    sort_attribute: "name"
    kind: role
  register: result
  ignore_errors: True

- name: Listing Status
  assert:
    that:
      - result.response is defined
      - result.changed == false
      - result.failed == false
    fail_msg: "Unable to list roles using ascending name sorting"
    success_msg: "roles listed successfully using ascending name sorting"