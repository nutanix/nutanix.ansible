---
- name: Test Inventory Plugin
  hosts: all
  gather_facts: false
  vars_files:
    - nutanix.yml
  tasks:
    - name: Assert the number of VMs in case of fetch_all_vms is true # noqa run-once[task]
      ansible.builtin.assert:
        that:
          - ansible_play_hosts | length >= 0
        fail_msg: "No hosts found in inventory!"
        success_msg: "Found {{ ansible_play_hosts | length }} hosts in inventory!"
      run_once: true
      when: fetch_all_vms

    - name: Assert that host vars are defined like ansible_host, vm name, cluster name, vm ext id, cluster ext id, ansible user, memory gb
      ansible.builtin.assert:
        that:
          - hostvars[inventory_hostname].ansible_host is defined
          - hostvars[inventory_hostname].vm_name is defined
          - hostvars[inventory_hostname].cluster_name is defined
          - hostvars[inventory_hostname].vm_ext_id is defined
          - hostvars[inventory_hostname].cluster_ext_id is defined
          - hostvars[inventory_hostname].ansible_user == 'ansible_user'
          - hostvars[inventory_hostname].memory_gb is defined
          - (hostvars[inventory_hostname].memory_gb | float) == (hostvars[inventory_hostname].memory_size_bytes | float / 1073741824)
        fail_msg: "Host vars not found for {{ inventory_hostname }}"
        success_msg: "Host vars found for {{ inventory_hostname }}"

    - name: Assert host groups # noqa run-once[task]
      ansible.builtin.assert:
        that:
          - hostvars[inventory_hostname].groups is defined
          - hostvars[inventory_hostname].groups | length >= 5
          - hostvars[inventory_hostname].groups.all is defined
          - hostvars[inventory_hostname].groups.all | length >= 0
          - hostvars[inventory_hostname].groups.powered_on | length +
            hostvars[inventory_hostname].groups.powered_off | length ==
            hostvars[inventory_hostname].groups.all | length
          - hostvars[inventory_hostname].groups.high_memory | length +
            hostvars[inventory_hostname].groups.low_memory | length ==
            hostvars[inventory_hostname].groups.all | length
          - ('machine_' ~ hostvars[inventory_hostname].machine_type) in hostvars[inventory_hostname].groups.keys()
        fail_msg: "Hosts are not in the expected groups"
        success_msg: "Hosts are in the expected groups"
      run_once: true
      when:
        - hostvars[inventory_hostname].groups.powered_on is defined
        - hostvars[inventory_hostname].groups.powered_off is defined
        - hostvars[inventory_hostname].groups.high_memory is defined
        - hostvars[inventory_hostname].groups.low_memory is defined
        - ('machine_' ~ hostvars[inventory_hostname].machine_type) in hostvars[inventory_hostname].groups.keys()

    - name: Assert cluster group
      ansible.builtin.assert:
        that:
          - hostvars[inventory_hostname].cluster_name is defined
          - hostvars[inventory_hostname].cluster_ext_id is defined
          - ('cluster_' ~ (hostvars[inventory_hostname].cluster_ext_id | replace("-", "_"))) in hostvars[inventory_hostname].groups.keys()
        fail_msg: "Cluster group not found for {{ inventory_hostname }}"
        success_msg: "Cluster group found for {{ inventory_hostname }}"
      when:
        - hostvars[inventory_hostname].cluster_name is defined
        - hostvars[inventory_hostname].cluster_ext_id is defined
