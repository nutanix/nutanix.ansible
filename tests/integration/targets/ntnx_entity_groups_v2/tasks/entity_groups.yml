---
- name: Start ntnx_entity_groups_v2 tests
  ansible.builtin.debug:
    msg: start ntnx_entity_groups_v2 tests

- name: Generate random name
  ansible.builtin.set_fact:
    random_name: "{{ query('community.general.random_string', numbers=false, special=false, length=12)[0] }}"

- name: Set suffix_name
  ansible.builtin.set_fact:
    suffix_name: ansible-eg

- name: Set variables
  ansible.builtin.set_fact:
    eg1: "{{ random_name }}{{ suffix_name }}1"
    eg2: "{{ random_name }}{{ suffix_name }}2"

- name: Set ansible keys and values
  ansible.builtin.set_fact:
    keys:
      - "{{random_name}}{{suffix_name}}key1"
      - "{{random_name}}{{suffix_name}}key2"
      - "{{random_name}}{{suffix_name}}key3"
      - "{{random_name}}{{suffix_name}}key4"
    values:
      - "{{random_name}}{{suffix_name}}value1"
      - "{{random_name}}{{suffix_name}}value2"
      - "{{random_name}}{{suffix_name}}value3"
      - "{{random_name}}{{suffix_name}}value4"

- name: Set todelete list
  ansible.builtin.set_fact:
    todelete: []

- name: Set todelete_categories list
  ansible.builtin.set_fact:
    todelete_categories: []

- name: Create entity group with check mode enabled
  nutanix.ncp.ntnx_entity_groups_v2:
    state: present
    name: "test-ansible-entity-group-1"
    description: test-ansible-entity-group-2-desc
    allowed_config:
      entities:
        - select_by: EXT_ID
          type: KUBE_CLUSTER
          reference_ext_ids:
            - "83cbf00d-782f-4efc-87c8-4129f5942aaa"
            - "83cbf00d-782f-4efc-87c8-4129f5942bbb"
          kube_entities:
            - "kube-cluster-1"
            - "kube-cluster-2"
  register: result
  ignore_errors: true
  check_mode: true

- name: Create entity group with check mode enabled status
  ansible.builtin.assert:
    that:
      - result.response is defined
      - result.changed == False
      - result.failed == False
      - result.response.name == "test-ansible-entity-group-1"
      - result.response.description == "test-ansible-entity-group-2-desc"
      - result.response.allowed_config.entities[0].select_by == "EXT_ID"
      - result.response.allowed_config.entities[0].type == "KUBE_CLUSTER"
      - result.response.allowed_config.entities[0].reference_ext_ids == ["83cbf00d-782f-4efc-87c8-4129f5942aaa", "83cbf00d-782f-4efc-87c8-4129f5942bbb"]
      - result.response.allowed_config.entities[0].kube_entities == ["kube-cluster-1", "kube-cluster-2"]
    fail_msg: Create entity group with check mode enabled failed
    success_msg: Create entity group with check mode enabled passed

###################################################################################################

- name: Create categories for entity groups
  nutanix.ncp.ntnx_categories_v2:
    key: "{{ keys[item] }}"
    value: "{{ values[item] }}"
    description: "ansible-category"
  register: output
  ignore_errors: true
  loop: "{{ range(0, 2) | list }}"
  loop_control:
    label: "{{ item }}"

- name: Create categories for entity groups status
  ansible.builtin.assert:
    that:
      - output is defined
      - output.changed == true
      - output.results | length == 2
      - output.msg == "All items completed"
    success_msg: "Categories created successfully"
    fail_msg: "Categories creation failed"

- name: Save external IDs to the list
  ansible.builtin.set_fact:
    todelete_categories: "{{ todelete_categories + [ item.response.ext_id ] }}"
  with_items: "{{ output.results }}"

###################################################################################################

- name: Create entity group
  nutanix.ncp.ntnx_entity_groups_v2:
    state: present
    name: "{{ eg1 }}_entity_group"
    description: "{{ eg1 }}_entity_group_desc"
    allowed_config:
      entities:
        - select_by: CATEGORY_EXT_ID
          type: VM
          reference_ext_ids:
            - "{{ todelete_categories[0] }}"
            - "{{ todelete_categories[1] }}"
  register: result
  ignore_errors: true

- name: Create entity group Status
  ansible.builtin.assert:
    that:
      - result.response is defined
      - result.changed == True
      - result.failed == False
      - result.ext_id is defined
      - result.response.name == "{{ eg1 }}_entity_group"
      - result.response.description == "{{ eg1 }}_entity_group_desc"
      - result.response.allowed_config.entities[0].select_by == "CATEGORY_EXT_ID"
      - result.response.allowed_config.entities[0].type == "VM"
      - result.response.allowed_config.entities[0].reference_ext_ids == todelete_categories
      - result.response.allowed_config.entities[0].reference_ext_ids | length == todelete_categories | length
    fail_msg: Create entity group failed
    success_msg: Create entity group passed

- name: Debug result create entity group
  ansible.builtin.debug:
    var: result

- name: Save entity group ext_id to the list
  ansible.builtin.set_fact:
    todelete: "{{ todelete + [ result.ext_id ] }}"

###################################################################################################

- name: Create entity group with different configs
  nutanix.ncp.ntnx_entity_groups_v2:
    state: present
    name: "{{ eg2 }}_entity_group"
    description: "{{ eg2 }}_entity_group_desc"
    allowed_config:
      entities:
        - select_by: CATEGORY_EXT_ID
          type: SUBNET
          reference_ext_ids:
            - "{{ todelete_categories[0] }}"
            - "{{ todelete_categories[1] }}"
  register: result
  ignore_errors: true

- name: Create entity group with different configs Status
  ansible.builtin.assert:
    that:
      - result.response is defined
      - result.changed == True
      - result.failed == False
      - result.ext_id is defined
      - result.response.name == "{{ eg2 }}_entity_group"
      - result.response.description == "{{ eg2 }}_entity_group_desc"
      - result.response.allowed_config.entities[0].select_by == "CATEGORY_EXT_ID"
      - result.response.allowed_config.entities[0].type == "SUBNET"
      - result.response.allowed_config.entities[0].reference_ext_ids == todelete_categories
      - result.response.allowed_config.entities[0].reference_ext_ids | length == todelete_categories | length
    fail_msg: Create entity group with different configs failed
    success_msg: Create entity group with different configs passed

- name: Save entity group ext_id to the list
  ansible.builtin.set_fact:
    todelete: "{{ todelete + [ result.ext_id ] }}"

###################################################################################################

- name: Create entity group without name
  nutanix.ncp.ntnx_entity_groups_v2:
    state: present
    description: "{{ eg1 }}_entity_group_without_name_desc"
    allowed_config:
      entities:
        - select_by: CATEGORY_EXT_ID
          type: VM
          reference_ext_ids:
            - "{{ todelete_categories[0] }}"
            - "{{ todelete_categories[1] }}"
  register: result
  ignore_errors: true

- name: Create entity group without name Status
  ansible.builtin.assert:
    that:
      - result.changed == False
      - result.failed == True
      - result.msg == "state is present but any of the following are missing: name, ext_id"
    fail_msg: Create entity group without name did not fail as expected
    success_msg: Create entity group without name failed as expected

###################################################################################################

- name: Create entity group with wrong reference_ext_ids
  nutanix.ncp.ntnx_entity_groups_v2:
    state: present
    name: "{{ eg1 }}_entity_group_wrong_ref_ext_ids"
    description: "{{ eg1 }}_entity_group_wrong_ref_ext_ids_desc"
    allowed_config:
      entities:
        - select_by: CATEGORY_EXT_ID
          type: VM
          reference_ext_ids:
            - "83cbf00d-782f-4efc-87c8-4129f5942aaa"
            - "83cbf00d-782f-4efc-87c8-4129f5942bbb"
  register: result
  ignore_errors: true

- name: Create entity group with wrong reference_ext_ids Status
  ansible.builtin.assert:
    that:
      - result.response is defined
      - result.changed == False
      - result.failed == True
      - result.msg == "Task Failed"
    fail_msg: Create entity group with wrong reference_ext_ids did not fail as expected
    success_msg: Create entity group with wrong reference_ext_ids failed as expected

###################################################################################################

- name: Update entity group in check mode
  nutanix.ncp.ntnx_entity_groups_v2:
    state: present
    ext_id: "{{ todelete[0] }}"
    name: "{{ eg1 }}_entity_group_updated_name"
    description: "{{ eg1 }}_entity_group_updated_desc"
    allowed_config:
      entities:
        - select_by: CATEGORY_EXT_ID
          type: SUBNET
          reference_ext_ids:
            - "00062ffc-95ad-19e9-185b-ac1f6b6f97e2"
            - "00062ffc-95ad-19e9-185b-ac1f6b6f97a3"
  register: result
  ignore_errors: true
  check_mode: true

- name: Update entity group in check mode Status
  ansible.builtin.assert:
    that:
      - result.response is defined
      - result.changed == False
      - result.failed == False
      - result.response.name == "{{ eg1 }}_entity_group_updated_name"
      - result.response.description == "{{ eg1 }}_entity_group_updated_desc"
      - result.response.allowed_config.entities[0].select_by == "CATEGORY_EXT_ID"
      - result.response.allowed_config.entities[0].type == "SUBNET"
      - result.response.allowed_config.entities[0].reference_ext_ids == ["00062ffc-95ad-19e9-185b-ac1f6b6f97e2", "00062ffc-95ad-19e9-185b-ac1f6b6f97a3"]
      - result.response.allowed_config.entities[0].reference_ext_ids | length == 2
    fail_msg: Update entity group in check mode failed
    success_msg: Update entity group in check mode passed

###################################################################################################

- name: Update entity group
  nutanix.ncp.ntnx_entity_groups_v2:
    state: present
    ext_id: "{{ todelete[0] }}"
    name: "{{ eg1 }}_entity_group_updated_name"
    description: "{{ eg1 }}_entity_group_updated_desc"
  register: result
  ignore_errors: true

- name: Update entity group Status
  ansible.builtin.assert:
    that:
      - result.response is defined
      - result.changed == True
      - result.failed == False
      - result.ext_id is defined
      - result.response.name == "{{ eg1 }}_entity_group_updated_name"
      - result.response.description == "{{ eg1 }}_entity_group_updated_desc"
    fail_msg: Update entity group failed
    success_msg: Update entity group passed

###################################################################################################

- name: Update entity group with same values
  nutanix.ncp.ntnx_entity_groups_v2:
    state: present
    ext_id: "{{ todelete[0] }}"
    name: "{{ eg1 }}_entity_group_updated_name"
    description: "{{ eg1 }}_entity_group_updated_desc"
  register: result
  ignore_errors: true

- name: Update entity group with same values Status
  ansible.builtin.assert:
    that:
      - result.changed == False
      - result.failed == False
      - result.msg == "Nothing to change."
    fail_msg: Update entity group with same values failed
    success_msg: Update entity group with same values passed

###################################################################################################

- name: Update entity group without changing name
  nutanix.ncp.ntnx_entity_groups_v2:
    state: present
    ext_id: "{{ todelete[0] }}"
    description: "{{ eg1 }}_entity_group_updated_desc_without_name"
  register: result
  ignore_errors: true

- name: Update entity group without changing name Status
  ansible.builtin.assert:
    that:
      - result.changed == True
      - result.failed == False
      - result.response.description == "{{ eg1 }}_entity_group_updated_desc_without_name"
    fail_msg: Update entity group without changing name failed
    success_msg: Update entity group without changing name passed

###################################################################################################

- name: Update entity group with wrong ext_id
  nutanix.ncp.ntnx_entity_groups_v2:
    state: present
    ext_id: "83cbf00d-782f-4efc-87c8-4129f5942aaa"
    name: "{{ eg1 }}_entity_group_updated_name"
    description: "{{ eg1 }}_entity_group_updated_desc"
  register: result
  ignore_errors: true

- name: Update entity group with wrong ext_id Status
  ansible.builtin.assert:
    that:
      - result.changed == False
      - result.failed == True
      - result.msg == "Api Exception raised while fetching entity group info using ext_id"
    fail_msg: Update entity group with wrong ext_id did not fail as expected
    success_msg: Update entity group with wrong ext_id failed as expected

###################################################################################################

- name: List all entity groups
  nutanix.ncp.ntnx_entity_groups_info_v2:
  register: result
  ignore_errors: true

- name: List all entity groups Status
  ansible.builtin.assert:
    that:
      - result.response is defined
      - result.changed == False
      - result.failed == False
      - result.response | length >= 2
      - result.total_available_results is defined
      - result.total_available_results >= 2
    fail_msg: List all entity groups failed
    success_msg: All entity groups listed successfully

###################################################################################################

- name: List entity group using filter
  nutanix.ncp.ntnx_entity_groups_info_v2:
    filter: "name eq '{{ eg2 }}_entity_group'"
  register: result
  ignore_errors: true

- name: List entity group using filter Status
  ansible.builtin.assert:
    that:
      - result.response is defined
      - result.changed == False
      - result.failed == False
      - result.response | length == 1
    fail_msg: List entity group using filter failed
    success_msg: Entity group listed successfully using filter

###################################################################################################

- name: List entity group using limit
  nutanix.ncp.ntnx_entity_groups_info_v2:
    limit: 1
  register: result
  ignore_errors: true

- name: List entity group using limit Status
  ansible.builtin.assert:
    that:
      - result.response is defined
      - result.changed == False
      - result.failed == False
      - result.response | length == 1
    fail_msg: List entity group using limit failed
    success_msg: Entity group listed successfully using limit

###################################################################################################

- name: Get entity group using ext_id
  nutanix.ncp.ntnx_entity_groups_info_v2:
    ext_id: "{{ todelete[1] }}"
  register: result
  ignore_errors: true

- name: Debug result get entity group using ext_id
  ansible.builtin.debug:
    var: result

- name: Get entity group using ext_id Status
  ansible.builtin.assert:
    that:
      - result.response is defined
      - result.changed == False
      - result.failed == False
      - result.response.name == "{{ eg2 }}_entity_group"
      - result.response.ext_id == "{{ todelete[1] }}"
      - result.response.description == "{{ eg2 }}_entity_group_desc"
      - result.response.allowed_config.entities[0].select_by == "CATEGORY_EXT_ID"
      - result.response.allowed_config.entities[0].type == "SUBNET"
      - result.response.allowed_config.entities[0].reference_ext_ids == todelete_categories
      - result.response.allowed_config.entities[0].reference_ext_ids | length == todelete_categories | length
    fail_msg: Get entity group using ext_id failed
    success_msg: Entity group listed successfully using ext_id

###################################################################################################

- name: Get entity group using wrong ext_id
  nutanix.ncp.ntnx_entity_groups_info_v2:
    ext_id: "83cbf00d-782f-4efc-87c8-4129f5942aaa"
  register: result
  ignore_errors: true

- name: Get entity group using wrong ext_id Status
  ansible.builtin.assert:
    that:
      - result.response is defined
      - result.changed == False
      - result.failed == True
      - result.msg == "Api Exception raised while fetching entity group info using ext_id"
    fail_msg: Get entity group using wrong ext_id did not fail as expected
    success_msg: Get entity group using wrong ext_id failed as expected

###################################################################################################

- name: Delete entity group in check mode
  nutanix.ncp.ntnx_entity_groups_v2:
    ext_id: "{{ todelete[0] }}"
    state: absent
  register: result
  ignore_errors: true
  check_mode: true

- name: Delete entity group in check mode Status
  ansible.builtin.assert:
    that:
      - result.response is defined
      - result.changed == False
      - result.failed == False
      - result.msg == "Entity group with ext_id:{{ todelete[0] }} will be deleted."
    fail_msg: Delete entity group in check mode failed
    success_msg: Delete entity group in check mode passed

###################################################################################################

- name: Delete entity group with wrong ext_id
  nutanix.ncp.ntnx_entity_groups_v2:
    ext_id: "83cbf00d-782f-4efc-87c8-4129f5942aaa"
    state: absent
  register: result
  ignore_errors: true

- name: Delete entity group with wrong ext_id Status
  ansible.builtin.assert:
    that:
      - result.response is defined
      - result.changed == False
      - result.failed == True
      - result.msg == "Api Exception raised while fetching entity group info using ext_id"
    fail_msg: Delete entity group with wrong ext_id did not fail as expected
    success_msg: Delete entity group with wrong ext_id failed as expected

###################################################################################################

- name: Delete Created entity groups
  nutanix.ncp.ntnx_entity_groups_v2:
    ext_id: "{{ item }}"
    state: absent
  register: result
  loop: "{{ todelete }}"
  ignore_errors: true

- name: Deletion Status
  ansible.builtin.assert:
    that:
      - item.changed == True
      - item.failed == False
      - item.response.status == 'SUCCEEDED'
      - item.ext_id == item.ext_id
    fail_msg: "Unable to delete entity group"
    success_msg: "Entity group deleted successfully"
  loop: "{{ result.results }}"

###################################################################################################

- name: Delete Created categories
  nutanix.ncp.ntnx_categories_v2:
    ext_id: "{{item}}"
    state: absent
  register: result
  loop: "{{ todelete_categories }}"
  ignore_errors: true

- name: Deletion Status
  ansible.builtin.assert:
    that:
      - result.changed == True
      - result.results | length == todelete_categories | length
      - result.msg == "All items completed"
    fail_msg: "Unable to delete category key & value"
    success_msg: "Category key & value deleted successfully"
