---
- name: Assert inventory plugin fails with expected error when using invalid custom_ansible_host variable
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Run ansible-inventory expecting failure due to invalid variable
      ansible.builtin.command:
        cmd: >
          ansible-inventory
          --inventory nutanix.yml
          --graph
      register: inventory_result
      ignore_errors: true
      changed_when: false

    - name: Assert error message contains expected variable not found
      ansible.builtin.assert:
        that:
          - inventory_result.stderr is search("Variable 'name_of_vm' not found when formatting ansible_host")
        fail_msg: "Expected error message not found in inventory result"
        success_msg: "Expected error message found in inventory result"
