---
# =========================================================================
# Proxy Support Validation Tests - All 13 v4 API SDKs
# =========================================================================
# This test validates that proxy configuration works correctly for all
# v4 API client modules. Each SDK is tested by making a simple API call
# through the configured proxy.
# =========================================================================

# =========================================================================
# SDK 1: ntnx_vmm_py_client (vmm/api_client.py)
# =========================================================================
- name: "[1/13 VMM SDK] Testing Virtual Machine Management API (Credentials in URL)"
  ansible.builtin.debug:
    msg: "Calling ntnx_vms_info_v2 to list VMs via ntnx_vmm_py_client with credentials in URL..."

- name: "[1/13 VMM SDK] List VMs"
  nutanix.ncp.ntnx_vms_info_v2:
  register: vmm_result
  ignore_errors: true

- name: "[1/13 VMM SDK] Assertions"
  ansible.builtin.assert:
    that:
      - vmm_result is not failed
      - vmm_result.response is defined
    fail_msg: "VMM SDK test (Credentials in URL) failed: {{ vmm_result.msg | default('unknown error') }}"
    success_msg: "VMM SDK test (Credentials in URL) passed - retrieved {{ vmm_result.response | default([]) | length }} VMs"

- name: "[1/13 VMM SDK] Testing Virtual Machine Management API (Credentials defined in variables)"
  ansible.builtin.debug:
    msg: "Calling ntnx_vms_info_v2 to list VMs via ntnx_vmm_py_client with credentials defined in variables..."

- name: "[1/13 VMM SDK] List VMs"
  nutanix.ncp.ntnx_vms_info_v2:
    https_proxy: "{{ proxy.https_proxy_without_credentials }}"
    proxy_username: "{{ proxy.proxy_username }}"
    proxy_password: "{{ proxy.proxy_password }}"
  register: vmm_result_without_credentials
  ignore_errors: true

- name: "[1/13 VMM SDK] Assertions"
  ansible.builtin.assert:
    that:
      - vmm_result_without_credentials is not failed
      - vmm_result_without_credentials.response is defined
    fail_msg: "VMM SDK test (Credentials defined in variables) failed: {{ vmm_result_without_credentials.msg | default('unknown error') }}"
    success_msg: "VMM SDK test (Credentials defined in variables) passed - retrieved {{ vmm_result_without_credentials.response | default([]) | length }} VMs"

# =========================================================================
# SDK 2: ntnx_networking_py_client (network/api_client.py)
# =========================================================================
- name: "[2/13 Network SDK] Testing Networking API (Credentials in URL)"
  ansible.builtin.debug:
    msg: "Calling ntnx_vpcs_info_v2 to list VPCs via ntnx_networking_py_client with credentials in URL..."

- name: "[2/13 Network SDK] List VPCs"
  nutanix.ncp.ntnx_vpcs_info_v2:
  register: network_result
  ignore_errors: true

- name: "[2/13 Network SDK] Assertions"
  ansible.builtin.assert:
    that:
      - network_result is not failed
      - network_result.response is defined
    fail_msg: "Network SDK test (Credentials in URL) failed: {{ network_result.msg | default('unknown error') }}"
    success_msg: "Network SDK test (Credentials in URL) passed - retrieved {{ network_result.response | default([]) | length }} VPCs"

- name: "[2/13 Network SDK] Testing Networking API (Credentials defined in variables)"
  ansible.builtin.debug:
    msg: "Calling ntnx_vpcs_info_v2 to list VPCs via ntnx_networking_py_client with credentials defined in variables..."

- name: "[2/13 Network SDK] List VPCs"
  nutanix.ncp.ntnx_vpcs_info_v2:
    https_proxy: "{{ proxy.https_proxy_without_credentials }}"
    proxy_username: "{{ proxy.proxy_username }}"
    proxy_password: "{{ proxy.proxy_password }}"
  register: network_result_without_credentials
  ignore_errors: true

- name: "[2/13 Network SDK] Assertions"
  ansible.builtin.assert:
    that:
      - network_result_without_credentials is not failed
      - network_result_without_credentials.response is defined
    fail_msg: "Network SDK test (Credentials defined in variables) failed: {{ network_result_without_credentials.msg | default('unknown error') }}"
    success_msg: "Network SDK test (Credentials defined in variables) passed - retrieved {{ network_result_without_credentials.response | default([]) | length }} VPCs"

# =========================================================================
# SDK 3: ntnx_iam_py_client (iam/api_client.py)
# =========================================================================
- name: "[3/13 IAM SDK] Testing Identity & Access Management API (Credentials in URL)"
  ansible.builtin.debug:
    msg: "Calling ntnx_users_info_v2 to list users via ntnx_iam_py_client with credentials in URL..."

- name: "[3/13 IAM SDK] List Users"
  nutanix.ncp.ntnx_users_info_v2:
  register: iam_result
  ignore_errors: true

- name: "[3/13 IAM SDK] Assertions"
  ansible.builtin.assert:
    that:
      - iam_result is not failed
      - iam_result.response is defined
    fail_msg: "IAM SDK test (Credentials in URL) failed: {{ iam_result.msg | default('unknown error') }}"
    success_msg: "IAM SDK test (Credentials in URL) passed - retrieved {{ iam_result.response | default([]) | length }} users"

- name: "[3/13 IAM SDK] Testing Identity & Access Management API (Credentials defined in variables)"
  ansible.builtin.debug:
    msg: "Calling ntnx_users_info_v2 to list users via ntnx_iam_py_client with credentials defined in variables..."

- name: "[3/13 IAM SDK] List Users"
  nutanix.ncp.ntnx_users_info_v2:
    https_proxy: "{{ proxy.https_proxy_without_credentials }}"
    proxy_username: "{{ proxy.proxy_username }}"
    proxy_password: "{{ proxy.proxy_password }}"
  register: iam_result_without_credentials
  ignore_errors: true

- name: "[3/13 IAM SDK] Assertions"
  ansible.builtin.assert:
    that:
      - iam_result_without_credentials is not failed
      - iam_result_without_credentials.response is defined
    fail_msg: "IAM SDK test (Credentials defined in variables) failed: {{ iam_result_without_credentials.msg | default('unknown error') }}"
    success_msg: "IAM SDK test (Credentials defined in variables) passed - retrieved {{ iam_result_without_credentials.response | default([]) | length }} users"

# =========================================================================
# SDK 4: ntnx_clustermgmt_py_client (clusters_mgmt/api_client.py)
# =========================================================================
- name: "[4/13 ClusterMgmt SDK] Testing Cluster Management API (Credentials in URL)"
  ansible.builtin.debug:
    msg: "Calling ntnx_clusters_info_v2 to list clusters via ntnx_clustermgmt_py_client with credentials in URL..."

- name: "[4/13 ClusterMgmt SDK] List Clusters"
  nutanix.ncp.ntnx_clusters_info_v2:
  register: clustermgmt_result
  ignore_errors: true

- name: "[4/13 ClusterMgmt SDK] Assertions"
  ansible.builtin.assert:
    that:
      - clustermgmt_result is not failed
      - clustermgmt_result.response is defined
    fail_msg: "ClusterMgmt SDK test (Credentials in URL) failed: {{ clustermgmt_result.msg | default('unknown error') }}"
    success_msg: "ClusterMgmt SDK test (Credentials in URL) passed - retrieved {{ clustermgmt_result.response | default([]) | length }} clusters"

- name: "[4/13 ClusterMgmt SDK] Testing Cluster Management API (Credentials defined in variables)"
  ansible.builtin.debug:
    msg: "Calling ntnx_clusters_info_v2 to list clusters via ntnx_clustermgmt_py_client with credentials defined in variables..."

- name: "[4/13 ClusterMgmt SDK] List Clusters"
  nutanix.ncp.ntnx_clusters_info_v2:
    https_proxy: "{{ proxy.https_proxy_without_credentials }}"
    proxy_username: "{{ proxy.proxy_username }}"
    proxy_password: "{{ proxy.proxy_password }}"
  register: clustermgmt_result_without_credentials
  ignore_errors: true

- name: "[4/13 ClusterMgmt SDK] Assertions"
  ansible.builtin.assert:
    that:
      - clustermgmt_result_without_credentials is not failed
      - clustermgmt_result_without_credentials.response is defined
    fail_msg: "ClusterMgmt SDK test (Credentials defined in variables) failed: {{ clustermgmt_result_without_credentials.msg | default('unknown error') }}"
    success_msg: "ClusterMgmt SDK test (Credentials defined in variables) passed - retrieved {{ clustermgmt_result_without_credentials.response | default([]) | length }} clusters"

# =========================================================================
# SDK 5: ntnx_prism_py_client (prism/pc_api_client.py)
# =========================================================================
- name: "[5/13 Prism SDK] Testing Prism Central Configuration API (Credentials in URL)"
  ansible.builtin.debug:
    msg: "Calling ntnx_categories_info_v2 to list categories via ntnx_prism_py_client with credentials in URL..."

- name: "[5/13 Prism SDK] List Categories"
  nutanix.ncp.ntnx_categories_info_v2:
  register: prism_result
  ignore_errors: true

- name: "[5/13 Prism SDK] Assertions"
  ansible.builtin.assert:
    that:
      - prism_result is not failed
      - prism_result.response is defined
    fail_msg: "Prism SDK test (Credentials in URL) failed: {{ prism_result.msg | default('unknown error') }}"
    success_msg: "Prism SDK test (Credentials in URL) passed - retrieved {{ prism_result.response | default([]) | length }} categories"

- name: "[5/13 Prism SDK] Testing Prism Central Configuration API (Credentials defined in variables)"
  ansible.builtin.debug:
    msg: "Calling ntnx_categories_info_v2 to list categories via ntnx_prism_py_client with credentials defined in variables..."

- name: "[5/13 Prism SDK] List Categories"
  nutanix.ncp.ntnx_categories_info_v2:
    https_proxy: "{{ proxy.https_proxy_without_credentials }}"
    proxy_username: "{{ proxy.proxy_username }}"
    proxy_password: "{{ proxy.proxy_password }}"
  register: prism_result_without_credentials
  ignore_errors: true

- name: "[5/13 Prism SDK] Assertions"
  ansible.builtin.assert:
    that:
      - prism_result_without_credentials is not failed
      - prism_result_without_credentials.response is defined
    fail_msg: "Prism SDK test (Credentials defined in variables) failed: {{ prism_result_without_credentials.msg | default('unknown error') }}"
    success_msg: "Prism SDK test (Credentials defined in variables) passed - retrieved {{ prism_result_without_credentials.response | default([]) | length }} categories"

# =========================================================================
# SDK 6: ntnx_volumes_py_client (volumes/api_client.py)
# =========================================================================
- name: "[6/13 Volumes SDK] Testing Volumes/Storage API (Credentials in URL)"
  ansible.builtin.debug:
    msg: "Calling ntnx_volume_groups_info_v2 to list volume groups via ntnx_volumes_py_client with credentials in URL..."

- name: "[6/13 Volumes SDK] List Volume Groups"
  nutanix.ncp.ntnx_volume_groups_info_v2:
  register: volumes_result
  ignore_errors: true

- name: "[6/13 Volumes SDK] Assertions"
  ansible.builtin.assert:
    that:
      - volumes_result is not failed
      - volumes_result.response is defined
    fail_msg: "Volumes SDK test (Credentials in URL) failed: {{ volumes_result.msg | default('unknown error') }}"
    success_msg: "Volumes SDK test (Credentials in URL) passed - retrieved {{ volumes_result.response | default([]) | length }} volume groups"

- name: "[6/13 Volumes SDK] Testing Volumes/Storage API (Credentials defined in variables)"
  ansible.builtin.debug:
    msg: "Calling ntnx_volume_groups_info_v2 to list volume groups via ntnx_volumes_py_client with credentials defined in variables..."

- name: "[6/13 Volumes SDK] List Volume Groups"
  nutanix.ncp.ntnx_volume_groups_info_v2:
    https_proxy: "{{ proxy.https_proxy_without_credentials }}"
    proxy_username: "{{ proxy.proxy_username }}"
    proxy_password: "{{ proxy.proxy_password }}"
  register: volumes_result_without_credentials
  ignore_errors: true

- name: "[6/13 Volumes SDK] Assertions"
  ansible.builtin.assert:
    that:
      - volumes_result_without_credentials is not failed
      - volumes_result_without_credentials.response is defined
    fail_msg: "Volumes SDK test (Credentials defined in variables) failed: {{ volumes_result_without_credentials.msg | default('unknown error') }}"
    success_msg: "Volumes SDK test (Credentials defined in variables) passed - retrieved {{ volumes_result_without_credentials.response | default([]) | length }} volume groups"

# =========================================================================
# SDK 7: ntnx_dataprotection_py_client (data_protection/api_client.py)
# =========================================================================
- name: "[7/13 DataProtection SDK] Testing Data Protection API (Credentials in URL)"
  ansible.builtin.debug:
    msg: "Calling ntnx_recovery_points_info_v2 to list recovery points via ntnx_dataprotection_py_client with credentials in URL..."

- name: "[7/13 DataProtection SDK] List Recovery Points"
  nutanix.ncp.ntnx_recovery_points_info_v2:
  register: dataprotection_result
  ignore_errors: true

- name: "[7/13 DataProtection SDK] Assertions"
  ansible.builtin.assert:
    that:
      - dataprotection_result is not failed
      - dataprotection_result.response is defined
    fail_msg: "DataProtection SDK test (Credentials in URL) failed: {{ dataprotection_result.msg | default('unknown error') }}"
    success_msg: "DataProtection SDK test (Credentials in URL) passed - retrieved {{ dataprotection_result.response | default([]) | length }} recovery points"

- name: "[7/13 DataProtection SDK] Testing Data Protection API (Credentials defined in variables)"
  ansible.builtin.debug:
    msg: "Calling ntnx_recovery_points_info_v2 to list recovery points via ntnx_dataprotection_py_client with credentials defined in variables..."

- name: "[7/13 DataProtection SDK] List Recovery Points"
  nutanix.ncp.ntnx_recovery_points_info_v2:
    https_proxy: "{{ proxy.https_proxy_without_credentials }}"
    proxy_username: "{{ proxy.proxy_username }}"
    proxy_password: "{{ proxy.proxy_password }}"
  register: dataprotection_result_without_credentials
  ignore_errors: true

- name: "[7/13 DataProtection SDK] Assertions"
  ansible.builtin.assert:
    that:
      - dataprotection_result_without_credentials is not failed
      - dataprotection_result_without_credentials.response is defined
    fail_msg: "DataProtection SDK test (Credentials defined in variables) failed: {{ dataprotection_result_without_credentials.msg | default('unknown error') }}"
    success_msg: "DataProtection SDK test (Credentials defined in variables) passed - retrieved {{ dataprotection_result_without_credentials.response | default([]) | length }} recovery points"

# =========================================================================
# SDK 8: ntnx_microseg_py_client (flow/api_client.py)
# =========================================================================
- name: "[8/13 Flow/Microseg SDK] Testing Flow/Microsegmentation API (Credentials in URL)"
  ansible.builtin.debug:
    msg: "Calling ntnx_address_groups_info_v2 to list address groups via ntnx_microseg_py_client with credentials in URL..."

- name: "[8/13 Flow/Microseg SDK] List Address Groups"
  nutanix.ncp.ntnx_address_groups_info_v2:
  register: flow_result
  ignore_errors: true

- name: "[8/13 Flow/Microseg SDK] Assertions"
  ansible.builtin.assert:
    that:
      - flow_result is not failed
      - flow_result.response is defined
    fail_msg: "Flow/Microseg SDK test (Credentials in URL) failed: {{ flow_result.msg | default('unknown error') }}"
    success_msg: "Flow/Microseg SDK test (Credentials in URL) passed - retrieved {{ flow_result.response | default([]) | length }} address groups"

- name: "[8/13 Flow/Microseg SDK] Testing Flow/Microsegmentation API (Credentials defined in variables)"
  ansible.builtin.debug:
    msg: "Calling ntnx_address_groups_info_v2 to list address groups via ntnx_microseg_py_client with credentials defined in variables..."

- name: "[8/13 Flow/Microseg SDK] List Address Groups"
  nutanix.ncp.ntnx_address_groups_info_v2:
    https_proxy: "{{ proxy.https_proxy_without_credentials }}"
    proxy_username: "{{ proxy.proxy_username }}"
    proxy_password: "{{ proxy.proxy_password }}"
  register: flow_result_without_credentials
  ignore_errors: true

- name: "[8/13 Flow/Microseg SDK] Assertions"
  ansible.builtin.assert:
    that:
      - flow_result_without_credentials is not failed
      - flow_result_without_credentials.response is defined
    fail_msg: "Flow/Microseg SDK test (Credentials defined in variables) failed: {{ flow_result_without_credentials.msg | default('unknown error') }}"
    success_msg: "Flow/Microseg SDK test (Credentials defined in variables) passed - retrieved {{ flow_result_without_credentials.response | default([]) | length }} address groups"

# =========================================================================
# SDK 9: ntnx_lifecycle_py_client (lcm/api_client.py)
# =========================================================================
- name: "[9/13 LCM SDK] Testing Life Cycle Manager API (Credentials in URL)"
  ansible.builtin.debug:
    msg: "Calling ntnx_lcm_status_info_v2 to get LCM status via ntnx_lifecycle_py_client with credentials in URL..."

- name: "[9/13 LCM SDK] Get LCM Status"
  nutanix.ncp.ntnx_lcm_status_info_v2:
  register: lcm_result
  ignore_errors: true

- name: "[9/13 LCM SDK] Assertions"
  ansible.builtin.assert:
    that:
      - lcm_result is not failed
      - lcm_result.response is defined
    fail_msg: "LCM SDK test (Credentials in URL) failed: {{ lcm_result.msg | default('unknown error') }}"
    success_msg: "LCM SDK test (Credentials in URL) passed - LCM status retrieved successfully"

- name: "[9/13 LCM SDK] Testing Life Cycle Manager API (Credentials defined in variables)"
  ansible.builtin.debug:
    msg: "Calling ntnx_lcm_status_info_v2 to get LCM status via ntnx_lifecycle_py_client with credentials defined in variables..."

- name: "[9/13 LCM SDK] Get LCM Status"
  nutanix.ncp.ntnx_lcm_status_info_v2:
    https_proxy: "{{ proxy.https_proxy_without_credentials }}"
    proxy_username: "{{ proxy.proxy_username }}"
    proxy_password: "{{ proxy.proxy_password }}"
  register: lcm_result_without_credentials
  ignore_errors: true

- name: "[9/13 LCM SDK] Assertions"
  ansible.builtin.assert:
    that:
      - lcm_result_without_credentials is not failed
      - lcm_result_without_credentials.response is defined
    fail_msg: "LCM SDK test (Credentials defined in variables) failed: {{ lcm_result_without_credentials.msg | default('unknown error') }}"
    success_msg: "LCM SDK test (Credentials defined in variables) passed - LCM status retrieved successfully"

# =========================================================================
# SDK 10: ntnx_datapolicies_py_client (data_policies/api_client.py)
# =========================================================================
- name: "[10/13 DataPolicies SDK] Testing Data Policies API"
  ansible.builtin.debug:
    msg: "Calling ntnx_protection_policies_info_v2 to list protection policies via ntnx_datapolicies_py_client..."

- name: "[10/13 DataPolicies SDK] List Protection Policies"
  nutanix.ncp.ntnx_protection_policies_info_v2:
  register: datapolicies_result
  ignore_errors: true

- name: "[10/13 DataPolicies SDK] Assertions"
  ansible.builtin.assert:
    that:
      - datapolicies_result is not failed
      - datapolicies_result.response is defined
    fail_msg: "DataPolicies SDK test (Credentials in URL) failed: {{ datapolicies_result.msg | default('unknown error') }}"
    success_msg: "DataPolicies SDK test (Credentials in URL) passed - retrieved {{ datapolicies_result.response | default([]) | length }} protection policies"

- name: "[10/13 DataPolicies SDK] Testing Data Policies API (Credentials defined in variables)"
  ansible.builtin.debug:
    msg: "Calling ntnx_protection_policies_info_v2 to list protection policies via ntnx_datapolicies_py_client with credentials defined in variables..."

- name: "[10/13 DataPolicies SDK] List Protection Policies"
  nutanix.ncp.ntnx_protection_policies_info_v2:
    https_proxy: "{{ proxy.https_proxy_without_credentials }}"
    proxy_username: "{{ proxy.proxy_username }}"
    proxy_password: "{{ proxy.proxy_password }}"
  register: datapolicies_result_without_credentials
  ignore_errors: true

- name: "[10/13 DataPolicies SDK] Assertions"
  ansible.builtin.assert:
    that:
      - datapolicies_result_without_credentials is not failed
      - datapolicies_result_without_credentials.response is defined
    fail_msg: "DataPolicies SDK test (Credentials defined in variables) failed: {{ datapolicies_result_without_credentials.msg | default('unknown error') }}"
    success_msg: "DataPolicies SDK test (Credentials defined in variables) passed - retrieved {{ datapolicies_result_without_credentials.response | default([]) | length }} protection policies"

# =========================================================================
# SDK 11: ntnx_objects_py_client (objects/api_client.py)
# Note: Objects service may not be available/configured on all clusters
# =========================================================================
- name: "[11/13 Objects SDK] Testing Objects Storage API (Credentials in URL)"
  ansible.builtin.debug:
    msg: "Calling ntnx_object_stores_info_v2 to list object stores via ntnx_objects_py_client with credentials in URL..."

- name: "[11/13 Objects SDK] List Object Stores"
  nutanix.ncp.ntnx_object_stores_info_v2:
  register: objects_result
  ignore_errors: true

- name: "[11/13 Objects SDK] Assertions"
  ansible.builtin.assert:
    that:
      - objects_result is not failed
      - objects_result.response is defined
    fail_msg: "Objects SDK test (Credentials in URL) failed: {{ objects_result.msg | default('unknown error') }}"
    success_msg: "Objects SDK test (Credentials in URL) passed - retrieved {{ objects_result.response | default([]) | length }} object stores"

- name: "[11/13 Objects SDK] Testing Objects Storage API (Credentials defined in variables)"
  ansible.builtin.debug:
    msg: "Calling ntnx_object_stores_info_v2 to list object stores via ntnx_objects_py_client with credentials defined in variables..."

- name: "[11/13 Objects SDK] List Object Stores"
  nutanix.ncp.ntnx_object_stores_info_v2:
    https_proxy: "{{ proxy.https_proxy_without_credentials }}"
    proxy_username: "{{ proxy.proxy_username }}"
    proxy_password: "{{ proxy.proxy_password }}"
  register: objects_result_without_credentials
  ignore_errors: true

- name: "[11/13 Objects SDK] Assertions"
  ansible.builtin.assert:
    that:
      - objects_result_without_credentials is not failed
      - objects_result_without_credentials.response is defined
    fail_msg: "Objects SDK test (Credentials defined in variables) failed: {{ objects_result_without_credentials.msg | default('unknown error') }}"
    success_msg: "Objects SDK test (Credentials defined in variables) passed - retrieved {{ objects_result_without_credentials.response | default([]) | length }} object stores"

# =========================================================================
# SDK 12: ntnx_licensing_py_client (licensing/api_client.py)
# =========================================================================
- name: "[12/13 Licensing SDK] Testing Licensing API (Credentials in URL)"
  ansible.builtin.debug:
    msg: "Calling ntnx_eula_info_v2 to get EULA info via ntnx_licensing_py_client with credentials in URL..."

- name: "[12/13 Licensing SDK] Get EULA Info"
  nutanix.ncp.ntnx_eula_info_v2:
  register: licensing_result
  ignore_errors: true

- name: "[12/13 Licensing SDK] Assertions"
  ansible.builtin.assert:
    that:
      - licensing_result is not failed
      - licensing_result.response is defined
    fail_msg: "Licensing SDK test (Credentials in URL) failed: {{ licensing_result.msg | default('unknown error') }}"
    success_msg: "Licensing SDK test (Credentials in URL) passed - EULA info retrieved successfully"

- name: "[12/13 Licensing SDK] Testing Licensing API (Credentials defined in variables)"
  ansible.builtin.debug:
    msg: "Calling ntnx_eula_info_v2 to get EULA info via ntnx_licensing_py_client with credentials defined in variables..."

- name: "[12/13 Licensing SDK] Get EULA Info"
  nutanix.ncp.ntnx_eula_info_v2:
    https_proxy: "{{ proxy.https_proxy_without_credentials }}"
    proxy_username: "{{ proxy.proxy_username }}"
    proxy_password: "{{ proxy.proxy_password }}"
  register: licensing_result_without_credentials
  ignore_errors: true

- name: "[12/13 Licensing SDK] Assertions"
  ansible.builtin.assert:
    that:
      - licensing_result_without_credentials is not failed
      - licensing_result_without_credentials.response is defined
    fail_msg: "Licensing SDK test (Credentials defined in variables) failed: {{ licensing_result_without_credentials.msg | default('unknown error') }}"
    success_msg: "Licensing SDK test (Credentials defined in variables) passed - EULA info retrieved successfully"

# =========================================================================
# SDK 13: ntnx_security_py_client (security/api_client.py)
# =========================================================================
- name: "[13/13 Security SDK] Testing Security/STIG Compliance API (Credentials in URL)"
  ansible.builtin.debug:
    msg: "Calling ntnx_stigs_info_v2 to list STIGs via ntnx_security_py_client with credentials in URL..."

- name: "[13/13 Security SDK] List STIGs"
  nutanix.ncp.ntnx_stigs_info_v2:
  register: security_result
  ignore_errors: true

- name: "[13/13 Security SDK] Assertions"
  ansible.builtin.assert:
    that:
      - security_result is not failed
      - security_result.response is defined
    fail_msg: "Security SDK test (Credentials in URL) failed: {{ security_result.msg | default('unknown error') }}"
    success_msg: "Security SDK test (Credentials in URL) passed - retrieved {{ security_result.response | default([]) | length }} STIGs"

- name: "[13/13 Security SDK] Testing Security/STIG Compliance API (Credentials defined in variables)"
  ansible.builtin.debug:
    msg: "Calling ntnx_stigs_info_v2 to list STIGs via ntnx_security_py_client with credentials defined in variables..."

- name: "[13/13 Security SDK] List STIGs"
  nutanix.ncp.ntnx_stigs_info_v2:
    https_proxy: "{{ proxy.https_proxy_without_credentials }}"
    proxy_username: "{{ proxy.proxy_username }}"
    proxy_password: "{{ proxy.proxy_password }}"
  register: security_result_without_credentials
  ignore_errors: true

- name: "[13/13 Security SDK] Assertions"
  ansible.builtin.assert:
    that:
      - security_result_without_credentials is not failed
      - security_result_without_credentials.response is defined
    fail_msg: "Security SDK test (Credentials defined in variables) failed: {{ security_result_without_credentials.msg | default('unknown error') }}"
    success_msg: "Security SDK test (Credentials defined in variables) passed - retrieved {{ security_result_without_credentials.response | default([]) | length }} STIGs"

########################################################
# Negative Tests
########################################################
- name: "[Negative 1] Testing proxy configuration with invalid proxy URL"
  ansible.builtin.debug:
    msg: "Testing proxy configuration with invalid proxy URL..."

- name: "[Negative 1] List VMs with invalid proxy URL"
  nutanix.ncp.ntnx_vms_info_v2:
    https_proxy: "http://invalid.proxy.com"
  register: invalid_proxy_result
  ignore_errors: true

- name: "[Negative 1] Assertions"
  ansible.builtin.assert:
    that:
      - invalid_proxy_result is failed
    fail_msg: "Invalid proxy URL test failed"
    success_msg: "Invalid proxy URL test passed"

- name: "[Negative 2] Testing proxy configuration with valid proxy URL and invalid credentials"
  ansible.builtin.debug:
    msg: "Testing proxy configuration with valid proxy URL and invalid credentials..."

- name: "[Negative 2] List VMs with valid proxy URL and invalid credentials"
  nutanix.ncp.ntnx_vms_info_v2:
    https_proxy: "{{ proxy.https_proxy_without_credentials }}"
    proxy_username: "invalid"
    proxy_password: "invalid"
  register: invalid_proxy_result_without_credentials
  ignore_errors: true

- name: "[Negative 2] Assertions"
  ansible.builtin.assert:
    that:
      - invalid_proxy_result_without_credentials is failed
    fail_msg: "Invalid proxy URL test with valid proxy URL and invalid credentials failed"
    success_msg: "Invalid proxy URL test with valid proxy URL and invalid credentials passed"

- name: Final Validation - Verify all SDK tests passed
  ansible.builtin.assert:
    that:
      - vmm_result is not failed
      - vmm_result_without_credentials is not failed
      - network_result is not failed
      - network_result_without_credentials is not failed
      - iam_result is not failed
      - iam_result_without_credentials is not failed
      - clustermgmt_result is not failed
      - clustermgmt_result_without_credentials is not failed
      - prism_result is not failed
      - prism_result_without_credentials is not failed
      - volumes_result is not failed
      - volumes_result_without_credentials is not failed
      - dataprotection_result is not failed
      - dataprotection_result_without_credentials is not failed
      - flow_result is not failed
      - flow_result_without_credentials is not failed
      - lcm_result is not failed
      - lcm_result_without_credentials is not failed
      - datapolicies_result is not failed
      - datapolicies_result_without_credentials is not failed
      - objects_result is not failed
      - objects_result_without_credentials is not failed
      - licensing_result is not failed
      - licensing_result_without_credentials is not failed
      - security_result is not failed
      - security_result_without_credentials is not failed
      - invalid_proxy_result is failed
      - invalid_proxy_result_without_credentials is failed
    fail_msg: "One or more SDK proxy tests failed."
    success_msg: "All 13 SDK proxy connectivity tests passed successfully!"
